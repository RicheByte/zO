#!/bin/bash
# ZO - AI-Powered CLI Assistant
# Intelligent command-line interface for system administration and security research

# Configuration directories and files
ZO_DIR="$HOME/.zo"
ZO_CONFIG="$ZO_DIR/config"
ZO_KEY="$ZO_DIR/api_key"
ZO_LOGS="$ZO_DIR/logs"
ZO_HISTORY="$ZO_DIR/history"
ZO_SESSION="$ZO_DIR/session"
ZO_DASHBOARD="$ZO_DIR/dashboard.json"
ZO_TEMP="/tmp/zo_cli"
MAX_HISTORY=500
MAX_OUTPUT_LINES=100

# Terminal colors
RED='\033[0;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
PURPLE='\033[1;35m'
CYAN='\033[1;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# Initialize ZO directories and configuration
zo_init_dirs() {
    mkdir -p "$ZO_DIR" "$ZO_TEMP"
    touch "$ZO_LOGS" "$ZO_HISTORY" 2>/dev/null
    chmod 700 "$ZO_DIR" 2>/dev/null
    chmod 600 "$ZO_CONFIG" "$ZO_HISTORY" "$ZO_LOGS" 2>/dev/null || true
    
    # Initialize dashboard
    if [ ! -f "$ZO_DASHBOARD" ]; then
        cat > "$ZO_DASHBOARD" << EOF
{
    "commands_executed": 0,
    "queries_made": 0,
    "creation_date": "$(date)",
    "status": "active"
}
EOF
    fi
}

# Store API key securely
zo_key_store() {
    local api_key="$1"
    if [ -z "$api_key" ]; then
        echo -e "${RED}Error: No API key provided${NC}"
        return 1
    fi
    
    # Remove quotes if present
    api_key=$(echo "$api_key" | sed 's/^"//;s/"$//')
    
    # Use machine ID as encryption key
    local machine_id=$(cat /etc/machine-id 2>/dev/null || echo "ZO_$(date +%s)")
    
    echo "$api_key" | openssl enc -aes-256-ctr -salt -pbkdf2 -iter 1000 -pass pass:"$machine_id" -base64 -out "$ZO_KEY" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ“ API key stored securely${NC}"
        return 0
    else
        echo -e "${RED}Error: Failed to store API key${NC}"
        return 1
    fi
}

# Retrieve stored API key
zo_key_retrieve() {
    if [ ! -f "$ZO_KEY" ]; then
        return 1
    fi
    
    local machine_id=$(cat /etc/machine-id 2>/dev/null || echo "ZO_$(date +%s)")
    local api_key=$(openssl enc -d -aes-256-ctr -salt -pbkdf2 -iter 1000 -pass pass:"$machine_id" -base64 -in "$ZO_KEY" 2>/dev/null)
    
    if [ $? -eq 0 ] && [ -n "$api_key" ]; then
        echo "$api_key"
        return 0
    else
        return 1
    fi
}

# Initialize ZO with API key
zo_setup() {
    echo -e "${PURPLE}"
    echo "================================================"
    echo "           ZO CLI INITIALIZATION"
    echo "        AI-Powered Command Assistant"
    echo "================================================"
    echo -e "${NC}"
    
    if [ -f "$ZO_KEY" ]; then
        echo -e "${GREEN}ZO is already configured${NC}"
        return 0
    fi
    
    echo -e "${YELLOW}Step 1: Get your Google AI API key${NC}"
    echo "Visit: https://aistudio.google.com/app/apikey"
    echo ""
    
    read -r -p "Enter your API key: " api_key
    if [ -z "$api_key" ]; then
        echo -e "${RED}Error: No API key provided${NC}"
        return 1
    fi
    
    # Remove quotes if present
    api_key=$(echo "$api_key" | sed 's/^"//;s/"$//')
    
    # Test API key
    echo -e "${YELLOW}Testing API key...${NC}"
    local test_response=$(curl -s -X GET \
        "https://generativelanguage.googleapis.com/v1beta/models?key=$api_key")
    
    if echo "$test_response" | grep -q "gemini"; then
        echo -e "${GREEN}âœ“ API key verified successfully${NC}"
    else
        echo -e "${RED}Error: Invalid API key${NC}"
        return 1
    fi
    
    # Store the API key
    if zo_key_store "$api_key"; then
        echo -e "${GREEN}âœ“ API key stored securely${NC}"
        
        # Create configuration
        cat > "$ZO_CONFIG" << EOF
MAX_OUTPUT_LINES=$MAX_OUTPUT_LINES
MODEL=gemini-2.0-flash
TEMPERATURE=0.7
EOF
        
        echo -e "${GREEN}âœ“ ZO configured successfully${NC}"
        return 0
    else
        echo -e "${RED}Error: Setup failed${NC}"
        return 1
    fi
}

# Show ZO dashboard
zo_dashboard() {
    if [ ! -f "$ZO_DASHBOARD" ]; then
        echo -e "${RED}Error: Dashboard not found${NC}"
        return 1
    fi
    
    echo -e "${PURPLE}"
    echo "================================================"
    echo "              ZO CLI DASHBOARD"
    echo "          AI Command Assistant Status"
    echo "================================================"
    echo -e "${NC}"
    
    python3 - << EOF 2>/dev/null || echo -e "${RED}Error: Python not available${NC}"
import json
import os
from datetime import datetime

try:
    with open("$ZO_DASHBOARD", "r") as f:
        data = json.load(f)
    
    print("\033[1;35mðŸ“Š Statistics:\033[0m")
    print(f"   Commands Executed: {data.get('commands_executed', 0)}")
    print(f"   Queries Made: {data.get('queries_made', 0)}")
    
    # System info
    print(f"\n\033[1;36mï¿½ System Info:\033[0m")
    print(f"   OS: {os.uname().sysname} {os.uname().machine}")
    print(f"   Hostname: {os.uname().nodename}")
    print(f"   Created: {data.get('creation_date', 'Unknown')}")
    print(f"   Status: {data.get('status', 'Unknown')}")
    
    # Recent activity
    if os.path.exists("$ZO_LOGS"):
        with open("$ZO_LOGS", "r") as f:
            lines = f.readlines()[-10:]
        if lines:
            print(f"\n\033[1;32mðŸ“œ Recent Activity:\033[0m")
            for line in lines[-5:]:
                print(f"   {line.strip()}")
    
except Exception as e:
    print(f"Error reading dashboard: {e}")
EOF
}

# Update dashboard statistics
zo_update_stats() {
    local stat="$1"
    local value="$2"
    
    python3 - << EOF 2>/dev/null
import json

try:
    with open("$ZO_DASHBOARD", "r") as f:
        data = json.load(f)
    
    if "$value" == "increment":
        data["$stat"] = data.get("$stat", 0) + 1
    elif "$value" == "decrement":
        data["$stat"] = data.get("$stat", 0) - 1
    else:
        data["$stat"] = "$value"
    
    with open("$ZO_DASHBOARD", "w") as f:
        json.dump(data, f, indent=2)
except:
    pass
EOF
}

# Execute AI query
zo_query() {
    local prompt="$1"
    local context="$2"
    
    local api_key=$(zo_key_retrieve)
    if [ -z "$api_key" ]; then
        echo -e "${RED}Error: API key not found. Run 'zo init' first${NC}"
        return 1
    fi
    
    local system_prompt="You are ZO, an AI assistant specialized in system administration, security research, and technical problem-solving. Provide clear, accurate, and helpful responses. When suggesting commands, explain what they do and any important considerations."
    
    local full_prompt="$system_prompt Context: $context. User's question: $prompt"
    
    # Use Python to properly encode JSON and handle the API call
    local response=$(python3 -c "
import json
import urllib.request
import urllib.parse

def call_gemini_api(api_key, prompt):
    url = f'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={api_key}'
    
    data = {
        'contents': [{
            'parts': [{
                'text': prompt
            }]
        }],
        'generationConfig': {
            'temperature': 0.7,
            'maxOutputTokens': 2000,
            'topP': 0.8
        }
    }
    
    headers = {
        'Content-Type': 'application/json'
    }
    
    try:
        json_data = json.dumps(data).encode('utf-8')
        request = urllib.request.Request(url, data=json_data, headers=headers)
        
        with urllib.request.urlopen(request) as response:
            response_data = json.loads(response.read().decode('utf-8'))
            return response_data
    except Exception as e:
        return {'error': str(e)}

api_key = '$api_key'
prompt = '''$full_prompt'''

result = call_gemini_api(api_key, prompt)

if 'error' in result:
    print(f'API ERROR: {result[\"error\"]}')
elif 'candidates' in result and len(result['candidates']) > 0:
    text = result['candidates'][0]['content']['parts'][0]['text']
    print(text)
else:
    print('UNKNOWN RESPONSE FORMAT')
" 2>/dev/null)
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}Error: Failed to get AI response${NC}"
        return 1
    fi
    
    echo "$response"
}

# Execute a command
zo_execute_command() {
    local cmd="$1"
    
    echo -e "${GREEN}[ZO] Executing:${NC} ${CYAN}$cmd${NC}"
    echo "$(date): EXECUTED: $cmd" >> "$ZO_LOGS"
    echo "$cmd" >> "$ZO_HISTORY"
    zo_update_stats "commands_executed" "increment"
    
    eval "$cmd" 2>&1 | head -n ${MAX_OUTPUT_LINES:-100}
    local exit_code=${PIPESTATUS[0]}
    
    if [ $exit_code -eq 0 ]; then
        echo -e "${GREEN}âœ“ Command completed successfully${NC}"
    else
        echo -e "${RED}Command exited with code: $exit_code${NC}"
    fi
    
    return $exit_code
}

# Get system context
get_system_context() {
    local current_dir=$(pwd)
    local user=$(whoami)
    local system_info=$(uname -a 2>/dev/null || echo "Windows system")
    local network_status=$(ip route get 1 2>/dev/null | head -1 || echo "Network info unavailable")
    
    cat << EOF
Current Directory: $current_dir
User: $user
System: $system_info
Network: $network_status
EOF
}

# Ask ZO a question
zo_ask() {
    local question="$1"
    if [ -z "$question" ]; then
        echo -e "${RED}Error: No question provided${NC}"
        return 1
    fi
    
    echo -e "${YELLOW}Processing your query...${NC}"
    local context=$(get_system_context)
    local response=$(zo_query "$question" "$context")
    
    zo_update_stats "queries_made" "increment"
    
    if [ -z "$response" ] || [[ "$response" =~ "API ERROR" ]]; then
        echo -e "${RED}Error: Failed to get response${NC}"
        echo -e "${YELLOW}Details: $response${NC}"
        return 1
    fi
    
    echo -e "\n${GREEN}ZO Response:${NC}"
    echo -e "${CYAN}$response${NC}"
    
    # Check if response contains a command suggestion
    if echo "$response" | grep -qE '```|`[a-zA-Z]'; then
        echo ""
        read -r -p "Would you like to execute a suggested command? (y/n): " user_confirm
        if [[ "$user_confirm" =~ ^[Yy]$ ]]; then
            # Extract command from code blocks
            local command_to_execute=$(echo "$response" | grep -oP '```bash\K[^`]+' | head -1)
            if [ -z "$command_to_execute" ]; then
                command_to_execute=$(echo "$response" | grep -oP '`\K[^`]+' | head -1)
            fi
            
            if [ -n "$command_to_execute" ]; then
                command_to_execute=$(echo "$command_to_execute" | tr -d '\n' | xargs)
                echo -e "${YELLOW}Command to execute: $command_to_execute${NC}"
                read -r -p "Confirm execution? (y/n): " exec_confirm
                if [[ "$exec_confirm" =~ ^[Yy]$ ]]; then
                    zo_execute_command "$command_to_execute"
                else
                    echo -e "${YELLOW}Execution cancelled${NC}"
                fi
            else
                echo -e "${RED}No command found to execute${NC}"
            fi
        fi
    fi
}

# Show help
show_help() {
    echo -e "\n${PURPLE}ZO - AI-Powered CLI Assistant${NC}"
    echo -e "\n${GREEN}Commands:${NC}"
    echo -e "  ${CYAN}zo init${NC}                  - Initialize ZO with your API key"
    echo -e "  ${CYAN}zo ask \"question\"${NC}        - Ask ZO about security, commands, or technical topics"
    echo -e "  ${CYAN}zo execute \"command\"${NC}     - Execute a command directly"
    echo -e "  ${CYAN}zo status${NC}                - Show ZO dashboard and statistics"
    echo -e "  ${CYAN}zo reconfigure${NC}           - Reset and reconfigure ZO"
    echo -e "  ${CYAN}zo --help${NC}                - Show this help message"
    
    echo -e "\n${PURPLE}Examples:${NC}"
    echo -e "  ${GREEN}Ask Questions:${NC}"
    echo -e "    zo ask \"what is a port scan?\""
    echo -e "    zo ask \"how to check open ports on my system?\""
    echo -e "    zo ask \"show me basic nmap commands\""
    echo -e "    zo ask \"how to list running processes?\""
    echo -e ""
    echo -e "  ${GREEN}Execute Commands:${NC}"
    echo -e "    zo execute \"ls -la\""
    echo -e "    zo execute \"pwd\""
    echo -e "    zo execute \"whoami\""
    
    echo -e "\n${YELLOW}Setup:${NC} Get your free API key at https://aistudio.google.com/app/apikey"
    echo -e "${YELLOW}Note:${NC} Run 'zo init' on first use to set up your API key"
}

# Command line interface functions
cmd_help() {
    show_help
}

cmd_init() {
    zo_init_dirs
    zo_setup
}

cmd_ask() {
    local question="$1"
    if [ -z "$question" ]; then
        echo -e "${RED}Error: No question provided${NC}"
        echo "Usage: zo ask 'your question'"
        exit 1
    fi
    
    zo_init_dirs
    if ! zo_key_retrieve >/dev/null; then
        echo -e "${RED}Error: ZO not initialized. Run 'zo init' first${NC}"
        exit 1
    fi
    
    zo_ask "$question"
}

cmd_execute() {
    local command="$1"
    if [ -z "$command" ]; then
        echo -e "${RED}Error: No command provided${NC}"
        echo "Usage: zo execute 'your command'"
        exit 1
    fi
    
    zo_init_dirs
    zo_execute_command "$command"
}

cmd_status() {
    zo_init_dirs
    zo_dashboard
}

cmd_reconfigure() {
    zo_init_dirs
    rm -f "$ZO_KEY" "$ZO_CONFIG"
    echo -e "${YELLOW}Configuration cleared${NC}"
    zo_setup
}

# Main command dispatcher
main() {
    local command="$1"
    local argument="$2"
    
    case "$command" in
        --help|-h|help)
            cmd_help
            ;;
        init)
            cmd_init
            ;;
        ask)
            cmd_ask "$argument"
            ;;
        execute)
            cmd_execute "$argument"
            ;;
        status)
            cmd_status
            ;;
        reconfigure)
            cmd_reconfigure
            ;;
        *)
            if [ -z "$command" ]; then
                echo -e "${RED}Error: No command provided${NC}"
            else
                echo -e "${RED}Error: Unknown command '$command'${NC}"
            fi
            echo ""
            cmd_help
            exit 1
            ;;
    esac
}

# Cleanup temporary files on exit
zo_cleanup() {
    rm -rf "$ZO_TEMP"
}

trap zo_cleanup EXIT

# Start ZO CLI
main "$@"
